<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Veo3 Style Video Editor</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --dark: #1b263b;
            --light: #f8f9fa;
            --danger: #ef233c;
            --success: #4cc9f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f1f3f4;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            height: calc(100vh - 150px);
        }
        
        .editor-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .preview-container {
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            flex: 1;
        }
        
        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        
        #previewPlaceholder {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 18px;
            background-color: #333;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .timeline-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 250px;
            display: flex;
            flex-direction: column;
        }
        
        .tracks {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        
        .track {
            display: flex;
            align-items: center;
            height: 60px;
            position: relative;
        }
        
        .track-label {
            width: 100px;
            font-size: 12px;
            color: #666;
        }
        
        .clips-container {
            flex: 1;
            height: 60px;
            background-color: #e9ecef;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .clip {
            height: 50px;
            min-width: 80px;
            background-color: var(--accent);
            border-radius: 4px;
            margin-right: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            position: absolute;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clip.active {
            border: 2px solid var(--dark);
        }
        
        .playhead {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background-color: var(--danger);
            z-index: 10;
            pointer-events: none;
        }
        
        .sidebar {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .effect-card {
            aspect-ratio: 1/1;
            background-color: #e9ecef;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .export-option {
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .export-option.active {
            background-color: var(--primary);
            color: white;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Font Awesome icons */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* Transition effects panel */
        .transition-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .transition-card {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
        }
        
        /* Text editor modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Cloud storage panel */
        .cloud-storage {
            margin-top: 15px;
        }
        
        .storage-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .storage-item:hover {
            background-color: #e9ecef;
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Load FFmpeg -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="material-icons">videocam</i>
                <span>Advanced Veo3 Editor</span>
            </div>
            <div>
                <button id="exportBtn" class="btn btn-success">
                    <i class="material-icons">download</i>
                    Export Video
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="preview-container">
                    <div id="previewPlaceholder">
                        <i class="material-icons" style="font-size: 48px; margin-bottom: 10px;">videocam_off</i>
                        <div>Click Record to start capturing video</div>
                    </div>
                    <video id="videoPreview" controls></video>
                    <canvas id="videoCanvas" class="hidden"></canvas>
                </div>
                
                <div class="controls">
                    <button id="recordBtn" class="btn btn-primary">
                        <i class="material-icons">fiber_manual_record</i>
                        Record
                    </button>
                    <button id="importBtn" class="btn btn-outline">
                        <i class="material-icons">folder_open</i>
                        Import
                    </button>
                    <button id="addTextBtn" class="btn btn-outline">
                        <i class="material-icons">title</i>
                        Add Text
                    </button>
                    <button id="playBtn" class="btn btn-outline" disabled>
                        <i class="material-icons">play_arrow</i>
                        Play
                    </button>
                    <button id="splitBtn" class="btn btn-outline" disabled>
                        <i class="material-icons">content_cut</i>
                        Split
                    </button>
                    <button id="deleteBtn" class="btn btn-danger" disabled>
                        <i class="material-icons">delete</i>
                        Delete
                    </button>
                </div>
                
                <div class="timeline-container">
                    <div class="section-title">Multi-track Timeline</div>
                    <div class="tracks" id="tracksContainer">
                        <div class="track">
                            <div class="track-label">Video Track 1</div>
                            <div class="clips-container" id="videoTrack1">
                                <div class="playhead" id="playhead"></div>
                            </div>
                        </div>
                        <div class="track">
                            <div class="track-label">Video Track 2</div>
                            <div class="clips-container" id="videoTrack2"></div>
                        </div>
                        <div class="track">
                            <div class="track-label">Audio Track</div>
                            <div class="clips-container" id="audioTrack"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="section-title">Video Effects</div>
                    <div class="effects-grid">
                        <div class="effect-card" data-effect="blur">
                            <i class="material-icons">blur_on</i>
                            Blur
                        </div>
                        <div class="effect-card" data-effect="grayscale">
                            <i class="material-icons">invert_colors_off</i>
                            B&W
                        </div>
                        <div class="effect-card" data-effect="sepia">
                            <i class="material-icons">photo_filter</i>
                            Sepia
                        </div>
                        <div class="effect-card" data-effect="brightness">
                            <i class="material-icons">brightness_high</i>
                            Brightness
                        </div>
                        <div class="effect-card" data-effect="contrast">
                            <i class="material-icons">contrast</i>
                            Contrast
                        </div>
                        <div class="effect-card" data-effect="saturate">
                            <i class="material-icons">tonality</i>
                            Saturate
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="section-title">Transitions</div>
                    <div class="transition-panel">
                        <div class="transition-card" data-transition="fade">
                            <i class="material-icons">animation</i>
                            Fade
                        </div>
                        <div class="transition-card" data-transition="slide">
                            <i class="material-icons">slideshow</i>
                            Slide
                        </div>
                        <div class="transition-card" data-transition="zoom">
                            <i class="material-icons">zoom_in</i>
                            Zoom
                        </div>
                        <div class="transition-card" data-transition="wipe">
                            <i class="material-icons">transform</i>
                            Wipe
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="section-title">Motion Graphics</div>
                    <div class="effects-grid">
                        <div class="effect-card" data-template="lowerThird">
                            <i class="material-icons">subtitles</i>
                            Lower Third
                        </div>
                        <div class="effect-card" data-template="title">
                            <i class="material-icons">title</i>
                            Title
                        </div>
                        <div class="effect-card" data-template="endCredits">
                            <i class="material-icons">format_align_center</i>
                            End Credits
                        </div>
                        <div class="effect-card" data-template="social">
                            <i class="material-icons">share</i>
                            Social Media
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="section-title">Cloud Storage</div>
                    <div class="cloud-storage">
                        <div class="storage-item">
                            <i class="material-icons" style="margin-right: 8px;">cloud</i>
                            Google Drive
                        </div>
                        <div class="storage-item">
                            <i class="material-icons" style="margin-right: 8px;">cloud</i>
                            Dropbox
                        </div>
                        <div class="storage-item">
                            <i class="material-icons" style="margin-right: 8px;">cloud</i>
                            OneDrive
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="section-title">Export Settings</div>
                    <div class="export-options">
                        <div class="export-option active" data-quality="1080">
                            <span>1080p (Full HD)</span>
                            <i class="material-icons">check</i>
                        </div>
                        <div class="export-option" data-quality="720">
                            <span>720p (HD)</span>
                            <i class="material-icons">check</i>
                        </div>
                        <div class="export-option" data-quality="480">
                            <span>480p (SD)</span>
                            <i class="material-icons">check</i>
                        </div>
                    </div>
                    <div class="progress-container hidden" id="exportProgressContainer">
                        <div class="progress-bar" id="exportProgressBar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Editor Modal -->
    <div class="modal" id="textEditorModal">
        <div class="modal-content">
            <h3>Add Text to Video</h3>
            <div class="form-group">
                <label for="textContent">Text Content</label>
                <textarea id="textContent" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="textFont">Font</label>
                <select id="textFont">
                    <option value="Arial">Arial</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                </select>
            </div>
            <div class="form-group">
                <label for="textColor">Color</label>
                <input type="color" id="textColor" value="#ffffff">
            </div>
            <div class="form-group">
                <label for="textDuration">Duration (seconds)</label>
                <input type="number" id="textDuration" value="5" min="1">
            </div>
            <div class="modal-actions">
                <button id="cancelTextBtn" class="btn btn-outline">Cancel</button>
                <button id="applyTextBtn" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const videoPreview = document.getElementById('videoPreview');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const videoCanvas = document.getElementById('videoCanvas');
        const recordBtn = document.getElementById('recordBtn');
        const importBtn = document.getElementById('importBtn');
        const addTextBtn = document.getElementById('addTextBtn');
        const playBtn = document.getElementById('playBtn');
        const splitBtn = document.getElementById('splitBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const exportBtn = document.getElementById('exportBtn');
        const tracksContainer = document.getElementById('tracksContainer');
        const videoTrack1 = document.getElementById('videoTrack1');
        const videoTrack2 = document.getElementById('videoTrack2');
        const audioTrack = document.getElementById('audioTrack');
        const playhead = document.getElementById('playhead');
        const exportProgressContainer = document.getElementById('exportProgressContainer');
        const exportProgressBar = document.getElementById('exportProgressBar');
        
        // Modal elements
        const textEditorModal = document.getElementById('textEditorModal');
        const textContent = document.getElementById('textContent');
        const textFont = document.getElementById('textFont');
        const textColor = document.getElementById('textColor');
        const textDuration = document.getElementById('textDuration');
        const applyTextBtn = document.getElementById('applyTextBtn');
        const cancelTextBtn = document.getElementById('cancelTextBtn');
        
        // State
        let mediaRecorder;
        let recordedChunks = [];
        let videoClips = [];
        let audioClips = [];
        let textElements = [];
        let activeClipIndex = -1;
        let isRecording = false;
        let isPlaying = false;
        let currentTime = 0;
        let playInterval;
        let videoStream;
        let totalDuration = 0;
        let ffmpeg = null;
        
        // Initialize FFmpeg
        async function initFFmpeg() {
            const { createFFmpeg } = FFmpeg;
            ffmpeg = createFFmpeg({ log: true });
            await ffmpeg.load();
            console.log('FFmpeg loaded');
        }
        
        // Initialize
        init();
        
        function init() {
            setupEventListeners();
            checkCameraAccess();
            initFFmpeg();
        }
        
        function setupEventListeners() {
            // Record button
            recordBtn.addEventListener('click', toggleRecording);
            
            // Import button
            importBtn.addEventListener('click', importVideo);
            
            // Add text button
            addTextBtn.addEventListener('click', () => {
                textEditorModal.style.display = 'flex';
            });
            
            // Play button
            playBtn.addEventListener('click', togglePlayback);
            
            // Split button
            splitBtn.addEventListener('click', splitClip);
            
            // Delete button
            deleteBtn.addEventListener('click', deleteClip);
            
            // Export button
            exportBtn.addEventListener('click', exportVideo);
            
            // Text modal buttons
            applyTextBtn.addEventListener('click', applyTextToVideo);
            cancelTextBtn.addEventListener('click', () => {
                textEditorModal.style.display = 'none';
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === ' ') { // Spacebar for play/pause
                    e.preventDefault();
                    togglePlayback();
                } else if (e.key === 'r') { // R for record
                    e.preventDefault();
                    toggleRecording();
                }
            });
            
            // Effect cards
            document.querySelectorAll('.effect-card[data-effect]').forEach(card => {
                card.addEventListener('click', () => {
                    const effect = card.getAttribute('data-effect');
                    applyVideoEffect(effect);
                });
            });
            
            // Transition cards
            document.querySelectorAll('.transition-card').forEach(card => {
                card.addEventListener('click', () => {
                    const transition = card.getAttribute('data-transition');
                    applyTransition(transition);
                });
            });
            
            // Motion graphics templates
            document.querySelectorAll('.effect-card[data-template]').forEach(card => {
                card.addEventListener('click', () => {
                    const template = card.getAttribute('data-template');
                    addMotionGraphics(template);
                });
            });
            
            // Cloud storage items
            document.querySelectorAll('.storage-item').forEach(item => {
                item.addEventListener('click', () => {
                    const service = item.textContent.trim();
                    connectCloudStorage(service);
                });
            });
            
            // Export options
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.export-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    option.classList.add('active');
                });
            });
        }
        
        async function checkCameraAccess() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 },
                    audio: true 
                });
                
                // Show camera feed in preview
                videoPreview.srcObject = videoStream;
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Could not access camera. Please check permissions.');
            }
        }
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            try {
                if (!videoStream) {
                    await checkCameraAccess();
                }
                
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(videoStream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    addVideoClip(url, 5, 'videoTrack1'); // Assuming 5 seconds for demo
                    
                    // Reset preview to camera feed
                    videoPreview.srcObject = videoStream;
                    videoPreview.controls = false;
                };
                
                mediaRecorder.start(100); // Collect data every 100ms
                isRecording = true;
                recordBtn.innerHTML = '<i class="material-icons">stop</i> Stop';
                
                // Show video preview
                previewPlaceholder.classList.add('hidden');
                videoPreview.classList.remove('hidden');
                
                // Disable other buttons while recording
                playBtn.disabled = true;
                splitBtn.disabled = true;
                deleteBtn.disabled = true;
                importBtn.disabled = true;
                addTextBtn.disabled = true;
            } catch (err) {
                console.error('Error starting recording:', err);
                alert('Error starting recording. Please try again.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.innerHTML = '<i class="material-icons">fiber_manual_record</i> Record';
                
                // Re-enable buttons
                playBtn.disabled = videoClips.length === 0;
                splitBtn.disabled = videoClips.length === 0 || activeClipIndex === -1;
                deleteBtn.disabled = videoClips.length === 0 || activeClipIndex === -1;
                importBtn.disabled = false;
                addTextBtn.disabled = false;
            }
        }
        
        function importVideo() {
            // In a real app, this would open a file dialog
            // For demo, we'll simulate importing a video
            const demoVideos = [
                'https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4',
                'https://sample-videos.com/video123/mp4/480/sample_video_480x360_1mb.mp4'
            ];
            
            const randomVideo = demoVideos[Math.floor(Math.random() * demoVideos.length)];
            addVideoClip(randomVideo, 10, 'videoTrack1'); // 10 seconds for demo
            
            // Show the imported video
            previewPlaceholder.classList.add('hidden');
            videoPreview.classList.remove('hidden');
            videoPreview.src = randomVideo;
            videoPreview.controls = false;
        }
        
        function addVideoClip(videoUrl, duration, trackId) {
            const clipId = 'clip-' + Date.now();
            const clipElement = document.createElement('div');
            clipElement.className = 'clip';
            clipElement.id = clipId;
            clipElement.style.width = `${duration * 20}px`; // 20px per second
            clipElement.innerHTML = `
                <span>Clip ${videoClips.length + 1}</span>
            `;
            
            clipElement.addEventListener('click', () => selectClip(clipId));
            
            // Add to the specified track
            const track = document.getElementById(trackId || 'videoTrack1');
            track.appendChild(clipElement);
            
            videoClips.push({
                id: clipId,
                url: videoUrl,
                duration: duration,
                element: clipElement,
                effects: [],
                track: trackId || 'videoTrack1'
            });
            
            // Calculate total duration
            totalDuration = Math.max(totalDuration, 
                videoClips.reduce((sum, clip) => sum + clip.duration, 0));
            
            // Select the new clip
            selectClip(clipId);
            
            // Enable play button if this is the first clip
            if (videoClips.length === 1) {
                playBtn.disabled = false;
            }
        }
        
        function selectClip(clipId) {
            // Deselect all clips
            videoClips.forEach((clip, index) => {
                clip.element.classList.remove('active');
                if (clip.id === clipId) {
                    activeClipIndex = index;
                }
            });
            
            // Select the clicked clip
            const selectedClip = videoClips.find(clip => clip.id === clipId);
            if (selectedClip) {
                selectedClip.element.classList.add('active');
                
                // Show the selected clip in the preview
                videoPreview.srcObject = null;
                videoPreview.src = selectedClip.url;
                videoPreview.controls = false;
                
                // Enable split and delete buttons
                splitBtn.disabled = false;
                deleteBtn.disabled = false;
            }
        }
        
        function splitClip() {
            if (activeClipIndex === -1) return;
            
            // In a real app, this would split the clip at current playhead position
            alert('Splitting functionality would be implemented here. In this demo, we\'ll just simulate splitting the clip in half.');
            
            const clip = videoClips[activeClipIndex];
            const newDuration = clip.duration / 2;
            
            // Update current clip duration
            clip.duration = newDuration;
            clip.element.style.width = `${newDuration * 20}px`;
            clip.element.querySelector('span').textContent = `${newDuration.toFixed(1)}s`;
            
            // Add a new clip with the second half
            addVideoClip(clip.url, newDuration, clip.track);
        }
        
        function deleteClip(clipId) {
            if (activeClipIndex === -1) return;
            
            // If clipId is not provided, delete the active clip
            const deleteIndex = clipId ? videoClips.findIndex(clip => clip.id === clipId) : activeClipIndex;
            if (deleteIndex === -1) return;
            
            const clipToDelete = videoClips[deleteIndex];
            
            // Remove from DOM
            clipToDelete.element.remove();
            
            // Remove from array
            videoClips.splice(deleteIndex, 1);
            
            // Revoke object URL if it's a blob
            if (clipToDelete.url.startsWith('blob:')) {
                URL.revokeObjectURL(clipToDelete.url);
            }
            
            // Reset active clip
            activeClipIndex = -1;
            
            // Update total duration
            totalDuration = videoClips.reduce((sum, clip) => sum + clip.duration, 0);
            
            // Update preview
            if (videoClips.length > 0) {
                selectClip(videoClips[0].id);
            } else {
                videoPreview.src = '';
                videoPreview.srcObject = videoStream;
                playBtn.disabled = true;
                splitBtn.disabled = true;
                deleteBtn.disabled = true;
            }
        }
        
        function togglePlayback() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }
        
        function startPlayback() {
            if (videoClips.length === 0) return;
            
            isPlaying = true;
            playBtn.innerHTML = '<i class="material-icons">pause</i> Pause';
            
            // Start playhead animation
            let elapsed = 0;
            playInterval = setInterval(() => {
                elapsed += 0.1;
                currentTime = elapsed;
                
                // Update playhead position
                const percentage = Math.min(100, (elapsed / totalDuration) * 100);
                playhead.style.left = `${percentage}%`;
                
                // Find which clip is currently playing
                let timeCounter = 0;
                let currentClipIndex = 0;
                for (let i = 0; i < videoClips.length; i++) {
                    timeCounter += videoClips[i].duration;
                    if (elapsed <= timeCounter) {
                        currentClipIndex = i;
                        break;
                    }
                }
                
                // Show the current clip in preview
                if (videoClips[currentClipIndex].id !== videoPreview.src.split('/').pop()) {
                    videoPreview.src = videoClips[currentClipIndex].url;
                    videoPreview.currentTime = elapsed - videoClips.slice(0, currentClipIndex).reduce((sum, clip) => sum + clip.duration, 0);
                    videoPreview.play().catch(e => console.error('Play error:', e));
                }
                
                // Apply text elements that should be visible at this time
                updateTextElements(elapsed);
                
                // End of playback
                if (elapsed >= totalDuration) {
                    pausePlayback();
                    resetPlayhead();
                }
            }, 100);
        }
        
        function pausePlayback() {
            isPlaying = false;
            clearInterval(playInterval);
            playBtn.innerHTML = '<i class="material-icons">play_arrow</i> Play';
            videoPreview.pause();
        }
        
        function resetPlayhead() {
            playhead.style.left = '0%';
            currentTime = 0;
        }
        
        function applyVideoEffect(effect) {
            if (activeClipIndex === -1) return;
            
            const clip = videoClips[activeClipIndex];
            
            // In a real app, this would apply actual video effects using WebGL
            // For this demo, we'll just track the effects
            if (!clip.effects.includes(effect)) {
                clip.effects.push(effect);
            } else {
                clip.effects = clip.effects.filter(e => e !== effect);
            }
            
            console.log(`Applied ${effect} effect to clip ${activeClipIndex + 1}`);
            
            // In a real implementation, we would apply the effect using WebGL
            applyWebGLEffect(effect);
        }
        
        function applyWebGLEffect(effect) {
            // This is a placeholder for actual WebGL implementation
            console.log(`Applying ${effect} effect using WebGL`);
            
            // For a real implementation, you would:
            // 1. Create a WebGL context on a canvas
            // 2. Render the video frame by frame to the canvas
            // 3. Apply shaders based on the selected effect
            // 4. Display the canvas instead of the video element
        }
        
        function applyTransition(transition) {
            // In a real app, this would apply a transition between clips
            console.log(`Applying ${transition} transition`);
            
            // For a real implementation, you would:
            // 1. Detect adjacent clips
            // 2. Create a transition animation between them
            // 3. Apply the transition effect using WebGL or CSS animations
        }
        
        function addMotionGraphics(template) {
            // In a real app, this would add a motion graphics template
            console.log(`Adding ${template} motion graphics template`);
            
            // For a real implementation, you would:
            // 1. Have predefined templates (lower thirds, titles, etc.)
            // 2. Add them as overlay elements on the video
            // 3. Animate them using CSS or WebGL
        }
        
        function connectCloudStorage(service) {
            // In a real app, this would connect to cloud storage
            console.log(`Connecting to ${service}`);
            
            // For a real implementation, you would:
            // 1. Use the service's API (Google Drive, Dropbox, etc.)
            // 2. Authenticate the user
            // 3. Provide file browsing and import/export functionality
        }
        
        function applyTextToVideo() {
            const content = textContent.value;
            const font = textFont.value;
            const color = textColor.value;
            const duration = parseInt(textDuration.value);
            
            if (!content) {
                alert('Please enter some text');
                return;
            }
            
            // Add text to the video
            textElements.push({
                content,
                font,
                color,
                startTime: currentTime,
                duration,
                endTime: currentTime + duration
            });
            
            console.log('Added text:', {
                content,
                font,
                color,
                startTime: currentTime,
                duration,
                endTime: currentTime + duration
            });
            
            // Close the modal
            textEditorModal.style.display = 'none';
            
            // In a real implementation, you would:
            // 1. Create a text track or overlay
            // 2. Render the text on the video using WebGL or canvas
            // 3. Sync it with the video timeline
        }
        
        function updateTextElements(currentTime) {
            // In a real app, this would show/hide text elements based on current time
            textElements.forEach(text => {
                const isVisible = currentTime >= text.startTime && currentTime <= text.endTime;
                console.log(`Text "${text.content}" is ${isVisible ? 'visible' : 'hidden'} at ${currentTime}s`);
            });
        }
        
        async function exportVideo() {
            if (videoClips.length === 0) {
                alert('No clips to export. Record or import some video first.');
                return;
            }
            
            const selectedQuality = document.querySelector('.export-option.active').getAttribute('data-quality');
            console.log(`Exporting video at ${selectedQuality}p quality`);
            
            // Show progress bar
            exportProgressContainer.classList.remove('hidden');
            
            // In a real app, this would use FFmpeg.wasm to process the video
            // Here's a simplified example of how you might use it:
            
            try {
                // Simulate FFmpeg processing (in a real app, you would use actual FFmpeg commands)
                let progress = 0;
                const exportInterval = setInterval(() => {
                    progress += 5;
                    exportProgressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(exportInterval);
                        
                        // For a real export with FFmpeg.wasm:
                        // 1. Write input files to FFmpeg's virtual file system
                        // 2. Run FFmpeg commands to process the video
                        // 3. Read the output file
                        // 4. Create a download link for the user
                        
                        setTimeout(() => {
                            exportProgressContainer.classList.add('hidden');
                            alert(`Video exported successfully at ${selectedQuality}p resolution! (This is a demo - no actual file is created)`);
                            exportProgressBar.style.width = '0%';
                            
                            // Example of actual FFmpeg usage:
                            // processWithFFmpeg(videoClips, selectedQuality);
                        }, 500);
                    }
                }, 100);
            } catch (err) {
                console.error('Error exporting video:', err);
                alert('Error exporting video. Please try again.');
                exportProgressContainer.classList.add('hidden');
            }
        }
        
        async function processWithFFmpeg(clips, quality) {
            // This is an example of how you might use FFmpeg.wasm
            // Note: This won't work in this demo due to CORS and other limitations
            
            // Set output file name
            const outputFileName = 'output.mp4';
            
            // Write input files to FFmpeg's file system
            for (let i = 0; i < clips.length; i++) {
                const clip = clips[i];
                if (clip.url.startsWith('blob:')) {
                    const response = await fetch(clip.url);
                    const buffer = await response.arrayBuffer();
                    ffmpeg.FS('writeFile', `input${i}.mp4`, new Uint8Array(buffer));
                } else {
                    // For external URLs, you would need to handle CORS
                    console.log('Cannot process external URLs directly due to CORS');
                    return;
                }
            }
            
            // Run FFmpeg command
            // This is a simplified example - actual commands would be more complex
            await ffmpeg.run(
                '-i', 'input0.mp4',
                '-c:v', 'libx264',
                '-crf', '23',
                '-preset', 'fast',
                '-c:a', 'aac',
                '-b:a', '128k',
                outputFileName
            );
            
            // Read the result
            const data = ffmpeg.FS('readFile', outputFileName);
            
            // Create download link
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
